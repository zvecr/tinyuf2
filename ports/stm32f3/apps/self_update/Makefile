PORT = stm32f3
OUTNAME = update-tinyuf2-$(BOARD)

# skip bootloader src
BUILD_APPLICATION = 1

# skip tinyusb src
BUILD_NO_TINYUSB = 1

CFLAGS += -DTINYUF2_SELF_UPDATE -Wno-error=stringop-overread

include ../../../make.mk
include ../../port.mk

SRC_C += \
	apps/self_update/self_update.c \
	$(CURRENT_PATH)/bootloader_bin.c

include ../../../rules.mk

self-update: $(BUILD)/$(OUTNAME).uf2

UF2CONV_ARGS ?=
ifdef UF2_DEVICE_TYPE_ID
  UF2CONV_ARGS += --device-type $(UF2_DEVICE_TYPE_ID)
endif

$(BUILD)/$(OUTNAME).uf2: $(BUILD)/$(OUTNAME).hex
	@echo CREATE $@
	$(PYTHON3) $(TOP)/lib/uf2/utils/uf2conv.py -f $(UF2_FAMILY_ID) $(UF2CONV_ARGS) -c -o $@ $^
